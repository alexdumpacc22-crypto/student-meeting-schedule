<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRMSU - Student Meeting Scheduler</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3652/3652191.png">
    
    <!-- SheetJS library for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- University Header -->
        <div class="university-header">
            <div class="logo-container">
                <!-- Using a base64 encoded placeholder for the logo - replace with actual logo -->
                <svg viewBox="0 0 100 100" width="80" height="80">
                    <rect width="200" height="200" fill="#003366"/>
                    <img src="https://scontent.fcrk1-3.fna.fbcdn.net/v/t39.30808-6/428158663_779337364230080_2416610370381306_n.jpg?_nc_cat=101&ccb=1-7&_nc_sid=1d70fc&_nc_ohc=Q7a-8UpAscQQ7kNvwED2XYp&_nc_oc=Adl1QaH27Uo5VaTZPcDSdTGiEiwP8unpe59m4PYkDfiAx8F-368wTRhMwXgy8ShmP30&_nc_zt=23&_nc_ht=scontent.fcrk1-3.fna&_nc_gid=4IXWwsdP6sAetoKN1uCuRQ&oh=00_AftqFqvu7zYD9dHRvvCgXXtsTpZPtkIcSpen-rFYwhEV3Q&oe=69A63832">
                </svg>
            </div>
            <div class="university-text">
                <h1>President Ramon Magsaysay State University</h1>
                <h2>STUDENT MEETING SCHEDULER</h2>
                <p>Iba Zambales, 2201, Philippines</p>
            </div>
        </div>
<body>
    <div class="container">
        <!-- Login Section -->
        <div id="loginSection" class="login-container">
            <h2>Student Meeting Scheduler</h2>
            <div class="login-form">
                <div class="form-group">
                    <label for="studentId">Student ID</label>
                    <input type="text" id="studentId" placeholder="Enter your Student ID" required>
                </div>
                <div class="form-group">
                    <label for="studentName">Full Name</label>
                    <input type="text" id="studentName" placeholder="Enter your Full Name" required>
                </div>
                <div class="form-group">
                    <label for="department">Department</label>
                    <select id="department" required>
                        <option value="">Select Department</option>
                        <option value="Computer Science">Computer Science</option>
                        <option value="Engineering">Engineering</option>
                        <option value="Business">Business</option>
                        <option value="Arts">Arts</option>
                        <option value="Science">Science</option>
                    </select>
                </div>
                <button class="btn" onclick="login()">Login as Student</button>
                <div class="admin-link">
                    <a href="admin.html">üë§ Admin Login</a>
                </div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection" class="hidden">
            <div class="dashboard-header">
                <h2>Welcome, <span id="displayName"></span>!</h2>
                <div class="user-info">
                    <span id="displayId"></span>
                    <button class="btn btn-danger" onclick="logout()">Logout</button>
                </div>
            </div>

            <div class="alert" id="alertMessage"></div>

            <h3>Select Meeting Type</h3>
            <div class="meeting-types">
                <div class="meeting-card walk-in" onclick="selectMeetingType('walk-in')">
                    <h3>üö∂ Walk-in Meeting</h3>
                    <p>Instant in-person meeting</p>
                </div>
                <div class="meeting-card asynchronous" onclick="selectMeetingType('asynchronous')">
                    <h3>üíª Asynchronous</h3>
                    <p>Flexible timing, online</p>
                </div>
                <div class="meeting-card hybrid" onclick="selectMeetingType('hybrid')">
                    <h3>üîÑ Hybrid Meeting</h3>
                    <p>Mix of in-person & online</p>
                </div>
            </div>

            <!-- Calendar Section -->
            <div id="calendarSection" class="calendar-section hidden">
                <h3 id="selectedMeetingTypeDisplay"></h3>
                <div class="calendar-header">
                    <button class="btn" onclick="previousMonth()">‚Üê Previous</button>
                    <h3 id="currentMonthYear"></h3>
                    <button class="btn" onclick="nextMonth()">Next ‚Üí</button>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
                
                <div id="timeSlotsSection" class="time-slots hidden">
                    <h4>Select Time Slot for <span id="selectedDate"></span></h4>
                    <div class="time-grid" id="timeSlots"></div>
                </div>

                <button class="btn" onclick="confirmBooking()" id="confirmBookingBtn" style="margin-top: 20px;" disabled>Confirm Booking</button>
            </div>

            <!-- My Meetings -->
            <div class="meetings-list">
                <h3>My Scheduled Meetings</h3>
                <div id="meetingsList"></div>
            </div>

            <!-- Download Section -->
            <div class="download-section">
                <button class="btn btn-success" onclick="downloadMeetings('csv')">üì• Download as CSV</button>
                <button class="btn btn-secondary" onclick="downloadMeetings('excel')">üìä Download as Excel</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize data structure
        let currentUser = null;
        let selectedMeetingType = null;
        let selectedDate = null;
        let selectedTime = null;
        let currentDate = new Date();
        let availableDates = [];

        // Load data from localStorage
        let meetings = JSON.parse(localStorage.getItem('meetings')) || [];
        let users = JSON.parse(localStorage.getItem('users')) || [];

        function login() {
            const studentId = document.getElementById('studentId').value.trim();
            const studentName = document.getElementById('studentName').value.trim();
            const department = document.getElementById('department').value;

            if (!studentId || !studentName || !department) {
                showAlert('Please fill in all fields', 'error');
                return;
            }

            // Check if user exists in users database
            const existingUser = users.find(u => u.id === studentId);
            
            if (existingUser) {
                // Case 1: Same ID exists
                if (existingUser.name !== studentName) {
                    showAlert('This Student ID is already registered with a different name. Please use your correct Student ID.', 'error');
                    return;
                }
                
                // Case 2: Same ID and name, but different department
                if (existingUser.department !== department) {
                    if (confirm('This Student ID is registered under a different department. Do you want to update your department?')) {
                        // Update department
                        existingUser.department = department;
                        existingUser.lastLogin = new Date().toISOString();
                        localStorage.setItem('users', JSON.stringify(users));
                        showAlert('Department updated successfully!', 'success');
                    } else {
                        return;
                    }
                } else {
                    // Normal login - update last login
                    existingUser.lastLogin = new Date().toISOString();
                    localStorage.setItem('users', JSON.stringify(users));
                }
            } else {
                // Check if name is already used with a different ID (optional - you can enable/disable this)
                const existingName = users.find(u => u.name.toLowerCase() === studentName.toLowerCase());
                if (existingName) {
                    if (!confirm('This name is already registered with a different Student ID. Do you want to continue with this new ID?')) {
                        return;
                    }
                }
                
                // Create new user
                const newUser = {
                    id: studentId,
                    name: studentName,
                    department: department,
                    role: 'student',
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString()
                };
                users.push(newUser);
                localStorage.setItem('users', JSON.stringify(users));
            }

            // Set current user
            currentUser = {
                id: studentId,
                name: studentName,
                department: department,
                role: 'student',
                loginTime: new Date().toISOString()
            };

            document.getElementById('displayName').textContent = studentName;
            document.getElementById('displayId').textContent = `ID: ${studentId} | Dept: ${department}`;
            
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
            
            displayUserMeetings();
            showAlert('Login successful!', 'success');
            
            // Clear login form
            document.getElementById('studentId').value = '';
            document.getElementById('studentName').value = '';
            document.getElementById('department').value = '';
        }

        function logout() {
            currentUser = null;
            selectedMeetingType = null;
            selectedDate = null;
            selectedTime = null;
            
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('calendarSection').classList.add('hidden');
            
            showAlert('Logged out successfully!', 'success');
        }

        function selectMeetingType(type) {
            selectedMeetingType = type;
            selectedDate = null;
            selectedTime = null;
            
            let typeDisplay = {
                'walk-in': 'Walk-in Meeting',
                'asynchronous': 'Asynchronous Meeting',
                'hybrid': 'Hybrid Meeting'
            };
            
            document.getElementById('selectedMeetingTypeDisplay').textContent = 
                `Selected: ${typeDisplay[type]}`;
            
            generateAvailableDates();
            document.getElementById('calendarSection').classList.remove('hidden');
            document.getElementById('timeSlotsSection').classList.add('hidden');
            document.getElementById('confirmBookingBtn').disabled = true;
            
            renderCalendar();
        }

        function generateAvailableDates() {
            availableDates = [];
            const today = new Date();
            
            // Generate available dates for next 30 days
            for (let i = 1; i <= 30; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                
                // Skip weekends (Saturday and Sunday)
                if (date.getDay() !== 0 && date.getDay() !== 6) {
                    // Randomly make some dates unavailable
                    if (Math.random() > 0.3) {
                        availableDates.push(date.toISOString().split('T')[0]);
                    }
                }
            }
        }

        function renderCalendar() {
            if (!currentUser) return;
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('currentMonthYear').textContent = 
                new Date(year, month).toLocaleDateString('default', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            let calendarHTML = '';
            
            // Add day headers
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach(day => {
                calendarHTML += `<div class="calendar-day-header">${day}</div>`;
            });
            
            // Add empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                calendarHTML += '<div class="calendar-day"></div>';
            }
            
            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isAvailable = availableDates.includes(dateStr);
                const isBooked = meetings.some(m => m.date === dateStr && m.studentId === currentUser.id);
                const isSelected = selectedDate === dateStr;
                
                let classes = 'calendar-day';
                if (isBooked) classes += ' booked';
                else if (isSelected) classes += ' selected';
                else if (isAvailable) classes += ' available';
                
                calendarHTML += `<div class="${classes}" onclick="selectDate('${dateStr}', ${isAvailable && !isBooked})">${day}</div>`;
            }
            
            document.getElementById('calendarGrid').innerHTML = calendarHTML;
        }

        function selectDate(dateStr, isAvailable) {
            if (!isAvailable || !currentUser) return;
            
            selectedDate = dateStr;
            renderCalendar();
            
            // Show time slots
            document.getElementById('selectedDate').textContent = new Date(dateStr).toLocaleDateString();
            document.getElementById('timeSlotsSection').classList.remove('hidden');
            
            generateTimeSlots();
        }

        function generateTimeSlots() {
            if (!currentUser || !selectedDate) return;
            
            const timeSlots = [
                '09:00 AM', '10:00 AM', '11:00 AM', 
                '01:00 PM', '02:00 PM', '03:00 PM', '04:00 PM'
            ];
            
            let timeSlotsHTML = '';
            
            timeSlots.forEach(time => {
                const isBooked = meetings.some(m => 
                    m.date === selectedDate && 
                    m.time === time && 
                    m.studentId === currentUser.id
                );
                
                const isSelected = selectedTime === time;
                
                let classes = 'time-slot';
                if (isBooked) classes += ' booked';
                else if (isSelected) classes += ' selected';
                
                timeSlotsHTML += `<div class="${classes}" onclick="selectTime('${time}', ${!isBooked})">${time}</div>`;
            });
            
            document.getElementById('timeSlots').innerHTML = timeSlotsHTML;
        }

        function selectTime(time, isAvailable) {
            if (!isAvailable || !currentUser) return;
            
            selectedTime = time;
            generateTimeSlots();
            document.getElementById('confirmBookingBtn').disabled = false;
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        function confirmBooking() {
            if (!selectedDate || !selectedTime || !selectedMeetingType || !currentUser) {
                showAlert('Please complete all selections', 'error');
                return;
            }
            
            // Check for duplicate booking
            const existingBooking = meetings.some(m => 
                m.date === selectedDate && 
                m.time === selectedTime && 
                m.studentId === currentUser.id
            );
            
            if (existingBooking) {
                showAlert('You already have a meeting booked at this time', 'error');
                return;
            }
            
            const meeting = {
                id: Date.now(),
                studentId: currentUser.id,
                studentName: currentUser.name,
                department: currentUser.department,
                type: selectedMeetingType,
                date: selectedDate,
                time: selectedTime,
                bookedAt: new Date().toISOString()
            };
            
            meetings.push(meeting);
            localStorage.setItem('meetings', JSON.stringify(meetings));
            
            showAlert('Meeting booked successfully!', 'success');
            
            // Reset selections
            selectedDate = null;
            selectedTime = null;
            document.getElementById('timeSlotsSection').classList.add('hidden');
            document.getElementById('confirmBookingBtn').disabled = true;
            
            // Refresh displays
            renderCalendar();
            displayUserMeetings();
        }

        function displayUserMeetings() {
            if (!currentUser) return;
            
            const userMeetings = meetings.filter(m => m.studentId === currentUser.id);
            
            if (userMeetings.length === 0) {
                document.getElementById('meetingsList').innerHTML = '<p>No meetings scheduled yet.</p>';
                return;
            }
            
            let meetingsHTML = '';
            
            userMeetings.sort((a, b) => new Date(a.date) - new Date(b.date)).forEach(meeting => {
                const typeDisplay = {
                    'walk-in': 'üö∂ Walk-in',
                    'asynchronous': 'üíª Asynchronous',
                    'hybrid': 'üîÑ Hybrid'
                };
                
                meetingsHTML += `
                    <div class="meeting-item ${meeting.type}">
                        <div class="meeting-info">
                            <h4>${typeDisplay[meeting.type]}</h4>
                            <p>Date: ${new Date(meeting.date).toLocaleDateString()} at ${meeting.time}</p>
                            <p>Department: ${meeting.department}</p>
                        </div>
                        <button class="delete-btn" onclick="deleteMeeting(${meeting.id})">Cancel</button>
                    </div>
                `;
            });
            
            document.getElementById('meetingsList').innerHTML = meetingsHTML;
        }

        function deleteMeeting(meetingId) {
            if (!currentUser) return;
            
            if (confirm('Are you sure you want to cancel this meeting?')) {
                meetings = meetings.filter(m => m.id !== meetingId);
                localStorage.setItem('meetings', JSON.stringify(meetings));
                displayUserMeetings();
                renderCalendar();
                showAlert('Meeting cancelled successfully', 'success');
            }
        }

        function downloadMeetings(format) {
            if (!currentUser) {
                showAlert('Please login first', 'error');
                return;
            }
            
            const userMeetings = meetings.filter(m => m.studentId === currentUser.id);
            
            if (userMeetings.length === 0) {
                showAlert('No meetings to download', 'error');
                return;
            }

            // Prepare data for export
            const exportData = userMeetings.map(meeting => ({
                'Meeting ID': meeting.id,
                'Student ID': meeting.studentId,
                'Student Name': meeting.studentName,
                'Department': meeting.department,
                'Meeting Type': meeting.type.charAt(0).toUpperCase() + meeting.type.slice(1),
                'Date': new Date(meeting.date).toLocaleDateString(),
                'Time': meeting.time,
                'Booked At': new Date(meeting.bookedAt).toLocaleString()
            }));

            if (format === 'csv') {
                downloadAsCSV(exportData);
            } else if (format === 'excel') {
                downloadAsExcel(exportData);
            }
        }

        function downloadAsCSV(data) {
            // Define CSV headers
            const headers = ['Meeting ID', 'Student ID', 'Student Name', 'Department', 'Meeting Type', 'Date', 'Time', 'Booked At'];
            
            // Convert data to CSV format
            let csvContent = headers.join(',') + '\n';
            
            data.forEach(row => {
                const rowData = headers.map(header => {
                    const value = row[header];
                    // Handle values that contain commas or quotes
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                        return `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                });
                csvContent += rowData.join(',') + '\n';
            });

            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `meetings_${currentUser.id}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('Meetings downloaded as CSV successfully!', 'success');
        }

        function downloadAsExcel(data) {
            // Create worksheet
            const ws = XLSX.utils.json_to_sheet(data);
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Meetings');
            
            // Generate Excel file and trigger download
            const fileName = `meetings_${currentUser.id}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showAlert('Meetings downloaded as Excel successfully!', 'success');
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alertMessage');
            alert.textContent = message;
            alert.className = `alert ${type}`;
            
            setTimeout(() => {
                alert.className = 'alert';
            }, 3000);
        }

        // Also update admin.html to ensure unique student IDs
        // This function can be called from admin panel if needed
        function validateUniqueStudent(studentId, studentName) {
            const existingUser = users.find(u => u.id === studentId);
            if (existingUser && existingUser.name !== studentName) {
                return false;
            }
            return true;
        }
    </script>
    <div class="footer-api"><i class="fa fa-envelope"> üìß Email: @Prmsu.edu.ph - President Ramon Magsaysay State University | Main Campus </i></div>
</body>
</html>